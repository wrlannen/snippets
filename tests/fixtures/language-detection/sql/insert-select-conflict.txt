INSERT INTO orders (user_id, product_id, quantity, total_price)
SELECT 
  u.id,
  p.id,
  c.quantity,
  c.quantity * p.price
FROM cart_items c
JOIN users u ON c.user_id = u.id
JOIN products p ON c.product_id = p.id
WHERE c.user_id = 123
  AND p.stock >= c.quantity
ON CONFLICT (user_id, product_id) 
DO UPDATE SET quantity = EXCLUDED.quantity;
